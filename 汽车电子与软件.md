# can总线学习笔记

https://aijishu.com/a/1060000000221188

CAN 是 Controller Area Network 的缩写，是 ISO 国际标准化的串行通信协议。通俗来讲，CAN总线就是一种传输数据的线，用于在不同的ECU之间传输数据。

can总线的特点

1. 多主工作方式
2. 非破坏性位仲裁机制
3. 系统的柔性
4. 通信速度
5. 数据传输方式
6. 远程数据传输方式
7. 错误监测
8. 故障封闭	

can通信网络结构

1. OSI基本参照模型
2. can协议网络层次

# 高性能计算软件平台在多域融合下的挑战与实践

https://aijishu.com/a/1060000000223128

特斯拉对于智能汽车行业的变革的影响是巨大的，他不单单是技术的领导者，也是商业模式的先行者，他比较早就在自研软硬件一体。并且让软件可以收License，让很多软件开发者看到自己价值。在汽车行业率先推出SAAS(软件即服务）

在自动驾驶的三大技术模块（感知，规划/决策，控制）中，最复杂和难以预测的是感知模块。智能驾驶的感知领域有五大指标，分别是感知完成功能、性能、可用性、可靠性和可实现性。目前阶段感知技术的重点，已从早期的控制误警率，转变为避免漏识别，最大限度保证驾驶的安全。这就给软件算法、安全架构和传感器提出了挑战。

# [自动驾驶平台](https://aijishu.com/a/1060000000226062)

### **斯拉Autopilot 自动驾驶软件架构**

基于单一Linux 内核，打造了整套自动驾驶的软件方案，分别完成了从感知、决策规划和控制系统解决方案。

### **大众中央集中式软件参考架构**

vw.OS 采用的是基于Adaptive AUTOSAR面向服务的软件架构

### **华为MDC 智能驾驶计算平台架构**

此平台集成华为在ICT 领域30 多年的研发与生产制造经验，基于CPU 与AI 处理器芯片，搭载智能驾驶OS，兼容AUTOSAR，支持L2\~L5 平滑演进，结合配套的完善工具链，客户或生态合作伙伴可灵活快速的开发出针对不同应用场景的智能驾驶应用。

### **英伟达自动驾驶平台架构**

提供完整的硬件平台和基础软件平台Xavier

### **百度Apollo 开放平台架构**

百度Apollo 是一套软件平台，其依赖的计算平台硬件需要采用第三方的IPC，Apollo 开放平台架构



# 汽车bootloader介绍

两个字，烧录https://aijishu.com/a/1060000000224691

- 预编程：主要进行一些环境配置
- 编程：刷写过程
- 刷新完成：恢复配置

# 高性能芯片

https://aijishu.com/a/1060000000225431

芯片是半导体元件产品的统称，又称集成电路（IC, Integrated Circuit）。汽车芯片主要分为三大类：功能芯片（MCU，MicrocontrollerUnit）、功率半导体、传感器。

汽车电子电器架构和整车功能越来越复杂，需要计算能力更强大的硬件来支持越来越复杂的软件功能，随着ADAS、自动驾驶等应用场景的加入及未来域集中甚至中央计算机的E/E架构变更，多核系统的需求将更加明显。

# 车控操作系统现状分析（good）

节选《汽车控制总体技术要求研究报告》

![image-20240119132816321](C:\notreadpaper\assets\image-20240119132816321.png)

车控操作系统分为安全车控操作系统和智能驾驶操作系统，其中，安全车控操作系统主要面向经典车辆控制领域，如动力系统、底盘系统和车身系统等，该类操作系统对实时性和安全性要求极高，生态发展已趋于成熟。智能驾驶操作系统主要面向智能驾驶领域，应用于智能驾驶域控制器，该类操作系统对安全性和可靠性要求较高，同时对性能和运算能力的要求也较高。该类操作系统目前在全世界范围内都处于研究发展的初期，生态尚未完备。车载操作系统主要面向信息娱乐和智能座舱，主要应用于车机中控系统，对于安全性和可靠性的要求处于中等水平，该类操作系统发展迅速，依托于该类操作系统的生态也处于迅速发展时期。

汽车智能化与网联化发展趋势共同推动了汽车电子电气架构的变革，一方面是车内网络拓扑的优化和实时、高速网络的启用，另一方面是电子控制单元（ECU）的功能进一步集成到域控制器甚至车载计算机。汽车电子电气架构的演进趋势为从分布式架构到域集中式架构最后到中央集中式架构转变

![image-20240119133456215](C:\notreadpaper\assets\image-20240119133456215.png)

车控操作系统包括安全车控操作系统和智能驾驶操作系统。安全车控操作系统主要是实时操作系统（RTOS），主要应用对象是ECU。ECU 对安全车控操作系统最基本的要求是高实时性，系统需要在规定时间内完成资源分配、任务同步等指定动作。嵌入式实时操作系统具有高可靠性、实时性、交互性以及多路性的优势，系统响应极高，通常在毫秒或者微秒级别，满足了高实时性的要求。目前，主流的安全车控操作系统都兼容OSEK/VDX 和Classic AUTOSAR 这两类汽车电子软件标准。其中，Classic 平台基于OSEK/VDX 标准，定义了安全车控操作系统的技术规范。

![preview](C:\notreadpaper\assets\bV6TS.png)

### 安全车控操作系统
我国主机厂及零配件供应商目前主要使用Classic AUTOSAR 标准进行软件开发。一汽集团、长安集团等主机厂于2009 年开始利用Classic AUTOSAR 标准的工具进行ECU 的设计、开发、验证。同时，上汽集团、一汽集团、长安集团、奇瑞集团等主机厂和部分高校成立了CASA 联盟，旨在中国推广和发展AUTOSAR 架构。

### 智能驾驶操作系统

Adaptive AUTOSAR 系统主要适应于新的集中式的高性能计算平台，满足车内部件之间的高速通信需求和智能驾驶的高计算能力需求。仍存在很多问题，如传统的AUTOSAR 方法论配置繁琐，支持的通信速率低，不支持解耦部署策略和动态升级方案，特别是车车协同、车路协同、车云协同等还一直处于需求讨论阶段，没有支持的时间表。

ROS 作为最早开源的机器人软件中间件，很早就被机器人行业使用，很多知名的机器人开源库，比如基于quaternion 的坐标转换、3D 点云处理驱动、定位算法SLAM 等都是开源贡献者基于ROS 开发的。很多自动驾驶的原型系统中都能够看到 ROS 的身影，例如AUTOWARE，百度 Apollo 最初也是使用了 ROS，直至Apollo 3.5版本才切换至自研的车载中间件Cyber RT。

# CAN总线学习笔记2（待读）

在了解CAN总线的通信机制之前，首先需要了解CAN协议中五种类型的帧结构：

- 数据帧
- 遥控帧
- 错误帧
- 过载帧
- 帧间隔

# 汽车SOC芯片

芯片按照典型应用场景，通常可以分为消费级、工业级、车规级和军工级四个等级，其要求依次为军工>车规>工业>消费。

车企通常会要求供应商使用车规级元器件，以保证车载ECU产品的质量和可靠性，AEC-Q系列标准是行业公认的车规元器件认证标准。

AEC-Q: 集成电路IC，无源器件，分离半导体器件，多芯片组件，分离光电子器件，传感器

因此在激烈的车机市场竞争中，高通的低成本非车规系列和联发科的黄山系列就与车规方案形成了差异化定位，高通的QCM8953/QCM6125，联发科的MT8665/MT8666/MT8667非车规方案，主打中低端车机市场，提供低成本的座舱解决方案，南方某新能源大厂车型大部分车型采用高通低成本方案，长安和吉利大多数车型也在今年开始切MT8666方案。

# 车载网络现状



![image-20240122105005982](C:\notreadpaper\assets\image-20240122105005982.png)

# 驾驶计算平台架构（精读）

https://aijishu.com/a/1060000000240586

智能网联汽车计算平台架构核心构成：硬件平台+系统软件+功能软件。

- 系统软件层面，主要包括BSP（板级支持包）、hypervisor（虚拟化）、狭义OS内核、中间件组件等。
- 功能软件层面，主要为自动驾驶的核心共性功能模块，包括自动驾驶通用框架、网联模块、运控模块等，功能软件结合系统软件，共同构成宏观意义上给的自动驾驶操作系统。
- 应用软件层面，应用软件主要包括场景算法（涵盖数据感知、多元融合、决策规划、控制执行等）、数据地图等。

![image-20240122133309401](C:\notreadpaper\assets\image-20240122133309401.png)

### 软件层

![image-20240122133458687](C:\notreadpaper\assets\image-20240122133458687.png)

### **操作系统标准与 OS 内核**

车控OS与座舱OS从功能实现角度，车载操作系统可以大致分为车控操作系统和智能座舱操作系统：

- （1）**车控操作系统**：主要对应自动驾驶域、动力域、底盘域，用于实现车身底盘控制、动力系统和自动驾驶；
- （2）**智能座舱操作系统**：主要对应于座舱域，用于实现车载娱乐信息系统功能以及实现HMI相应功能。

在前述基础上，我们可以进一步划分车控操作系统：

- （1）嵌入式实时操作系统RTOS：用于传统的车辆控制，适用于动力系统与底盘控制等领域；

- （2）基于POSIX标准的操作系统，适用于自动驾驶所需要的高性能计算和高宽带通信。

  <img src="C:\notreadpaper\assets\image-20240122144427823.png" alt="image-20240122144427823" style="zoom: 67%;" />

传统车控ECU采用的符合OSEK/VDX和Classic AUTOSAR标准的RTOS。在传统的分布式EE架构下，特定的ECU针对处理特定功能，常见ECU包括EMS发动机电控系统，ABS制动防抱死控制、变速箱牵引力控制TCU、电子稳定控制EPS、电子动力转向EPS，新能源汽车整车控制VCU，电池管理系统BMS等。通常情况下，车用ECU主要由MCU、存储器、I/O和外围电路组成，其中MCU为核心。

传统ECU实施的功能有限，运行相对简易，并不需要高性能的OS来实现资源的调度和分配。不过因为涉及车控环节，相关系统属于复杂测控系统，如果系统任务的响应不及时或有延迟过大，就可能导致严重的安全隐患。因此汽车电控ECU必须是高稳定性的嵌入式实时性操作系统（RTOS），实时性的含义是系统保证在一定时间限制内完成特定功能，目前主流的电控操作系统基本都兼容OSEK/VDX和ClassicAUTOSAR这两类汽车电子软件标准。

值得指出的是，AUTOSAR与OSEK都是汽车电子软件的标准，AUTOSAR基于OSEK/VDX发展而来。OSEK/VDX是基于ECU开发的操作系统标准，起源于20世纪90年代，AUTOSAR基于整体汽车电子开发的功能标准，发起于2003年。

自动驾驶OS目前大多参考Adaptive AUTOSAR平台，其定义采用了基于POSIX标准的操作系统，可以为支持POSIX标准的操作系统及不同的应用需求提供标准化的平台接口和应用服务。从实际功能执行来看，可以将ECU的软件平台分为三类：基于信息娱乐的ECU、传统的基于控制的ECU，以及执行自动驾驶功能的ECU。

Classic AUTOSAR标准解决了传统车控ECU的需求，但是，如高级辅助驾驶和自动驾驶，需要在车辆上引入高度复杂和计算资源需求量大的软件，同时这些软件在车辆上必须完全兼容和绝对安全，而且未来随着汽车电子及软件功能的大幅增长，最终可能向基于中央计算机的车辆集中式电子电气架构，对于自动驾驶域控制器或计算平台这种控制器，Classic AUTOSAR无法满足其需求，需要高度灵活、高性能且支持HPC、动态通讯等特性的新软件架构平台。

2018年，为了迎合未来汽车智能化、网联化的需求，AUTOSAR联盟推出了一个全新的平台，将AP加入到原有的AUTOSAR平台中，形成Adaptive AUTOSAR平台，并于2018年10月迎来了适用于面向量产的首次发布，另外还将原有平台更名为Classic AUTOSAR平台。

OS内核又称为底层OS，旨在提供操作系统最基本的功能，负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。

### **中间件及核心共性功能模块**

中间件是介于应用系统和系统软件之间的一类软件，位于客户机服务器的操作系统之上，管理计算资源和网络通信。

2020年7月，博世推出针对高级自动驾驶应用的中间件—Iceoryx (冰羚)，兼容ROS2和Adaptive AutoSAR的接口，满足不同开发阶段的需求。020年12月，采埃孚发布中间件ZF Middleware，提供可以集成到整车制造商软件平台的模块化解决方案。同时，该中间件将于2024年搭载在量产车辆上。值得注意的是，国外Tier 1在功能落地的同时，开始渗透底层系统研发，搭建系统与软件应用之间的连接桥梁。博世、采埃孚相继发布中间件产品，以期通过全面的传感器产品布局，为主机厂集中配置自动驾驶方案，降低系统集成的复杂性，降低开发成本和加快产品落地。

![image-20240122150030457](C:\notreadpaper\assets\image-20240122150030457.png)

![image-20240122150427867](C:\notreadpaper\assets\image-20240122150427867.png)

### 应用：各种场景

我们仅以场景算法进行阐述，典型的场景算法设计数据感知、决策规划、控制执行等。其中感知类算法包括SLAM算法（涵盖视觉处理、激光雷达、多传感器融合等）、自动驾驶感知算法。决策类算法包括自动驾驶规划算法、自动驾驶决策算法，执行类算法主要为自动驾驶控制算法。

数据地图（高精度地图）也是应用层又一典型软件。

![image-20240122153245897](C:\notreadpaper\assets\image-20240122153245897.png)

## 底层硬件

**CPU+GPU+ASIC（英伟达、特斯拉、高通等为代表）**

**CPU+ASIC（Mobileye、华为、地平线等为代表）**

地平线属于我国第一个实现车规级AI芯片前装量产的企业。2019年公司发布征程2，已公布搭载地平线征程2芯片的有长安UNI-T、奇瑞蚂蚁、智己汽车、长安UNI-K、广汽埃安AION Y、东风岚图Free、江淮汽车思皓QX、广汽传祺GS4 Plus、上汽大通MAXUS MIFA概念车9款车型。

**CPU+ FPGA（百度-赛灵思、Waymo等为代表）**

# ECU的bootloader

BootLoad(简称Boot)是一种启动加载程序，或者称为引导程序，我们在操作系统和嵌入式开发中经常用到，因为汽车ECU也是一种嵌入式系统，Boot程序主要用于ECU软件更新，汽车OTA升级。

# 《中国汽车基础软件发展白皮书2.0》

随着汽车电子化程度的加速渗透，汽车ECU的数量也在快速上升，而ECU中均需要 MCU芯片。根据相关数据统计，普通燃油车的ECU数量在70个左右，高端车型的 ECU数量在150个左右，而智能汽车的ECU数量在 300个左右。

# AutoSar MemStack介绍

MemStack 以NvM （Non-Volatile RAM Manager）模块向User提供各种非易失存储器的数据管理，NvM模块自身是独立于硬件的，但所有的功能都是直接访问硬件的，包括内部/外部的 EEP,或者是内部/外部的Flash 模拟的EEP。NVRAM 管理器处理对非易失性数据的并发访问，并提供可靠性机制，如单个数据元素的校验和保护。MemService 由NvM MemIf EA Eep Fee Fls组成,支持对Flash 和Eeprom的数据集成管理，本文主要通过介绍NvM MemIf Fee EA 等模块来认识MemStack。

# 特斯拉EEA

2018年推出的Model 3在电子电气架构上向前进化了两个世代，原先的区域划分完全不见了，取而代之的是三个车身控制器和一个中央计算平台CCM。个车身控制器按照布置位置被命名为Body Controller Front、Body Controller Left、Body Controller Right。

Body Controller Front负责整车电源分配，车辆前舱用电器的逻辑控制和驱动；

Body Controller Left负责左侧用电器的配电，左侧用电器的逻辑控制和驱动；

Body Controller Right负责右侧用电器的配电，右侧和背部用电器的逻辑控制和驱动；

# Aurora -- Lidar（论文）

https://aijishu.com/a/1060000000285929

除了激光雷达技术和激光雷达芯片技术，Aurora的自动驾驶算法很少公开，最近上市前的融资材料公布了一些信息：这是Aurora Driver平台概览：软件、硬件、地图、数据服务、车辆

![2024-01-23_15h39_28](C:\notreadpaper\assets\2024-01-23_15h39_28-1705995614021-3.png)

这是其全栈自动驾驶技术一览：传感器、定位、地图、感知、规划、控制、仿真、线控

![2024-01-23_15h39_18](C:\notreadpaper\assets\2024-01-23_15h39_18.png)

1. 这是其激光雷达的优点介绍：长距离感知、抗干扰，能同时测速和距离
2. 提供仿真测试和数据回放的示意图：减少路测、其运动规划仿真比路测成本减少2500+倍，1小时仿真测试相当于5万个车辆路测，其中可以模拟2百25万次无保护左拐弯。高清地图制作Aurora Atlas：几乎实时更新、制图过程大规模并行
3. 最后正在开发的自动驾驶2.0系统，和自动驾驶1.0系统比较如下：

### **“LaserFlow: Efficient and Probabilistic Object Detection and Motion Forecasting”**

提出的一个方法，LaserFlow，基于激光雷达的三维目标检测和运动预测。该方法利用激光雷达的距离视图（RV）表示 ，在传感器的全距离实时操作，没有BEV的体素化或数据压缩。提出的多扫描（multi- sweep）融合架构，直接从距离图像提取和合并时域特征。此外，受课程学习启发提出一种技术，学习未来的轨迹的概率分布。

###  **”Map-Adaptive Goal-Based Trajectory Prediction”**

提出一种多模态、长时车辆轨迹预测方法，GoalNet。该方法依赖于在丰富的环境地图中捕获的车道中心线为每辆车生成一组建议的目标路径（goal paths）。用这些运行时生成、动态适应场景的路径作为空域锚，预测一组基于目标（goal-based）的轨迹以及这些目标上的类别分布。这种方法能够直接模拟交通参与者的目标导向（goal- directed）行为，释放更准确长时预测的潜力。在大规模内部驾驶数据集和公共数据集nuScenes上的实验结果表明，该模型能够更好地推广到一个完全新出现城市的道路场景。

# 汽车导线

汽车上的导线可分为蓄电池线、高压导线（新能源汽车用，耐压等级DC大于60V小于600V），同轴电缆、低压导线（耐压等级DC<60V或AC<25V）等

选择因素：

1. 导线材料
2. 导线温度
3. 导线材质
4. 导线结构
5. 导线面积

上述只是导线选型的一般方法，导线选型考虑的其他因素还包括端子压接要求，共保险负载电源线径一致要求等。另外，整车电源系统在设计完成后，要进行各项电性能的测试，包括单负载、全负载、135%过载、200%过载、短路测试等，验证保险和导线设计的合理性，只有通过测试的设计才算是合理的设计。

# Google Waymo Analysis

问题：反射问题，行人伪装，现实问题

解决：由于激光雷达，反射问题可以得到解决。反射不会出现在激光雷达中；只有点云显示了真正障碍物的形状（这里是一辆公共汽车）。了解更多的激光雷达信息。

#### **架构**

最近在讨论Tesla计算机视觉架构时，我探索了HydraNet 架构。它是一种旨在同时运行多个神经网络的架构。“Hydra”这个词意味着一个有多个头的系统。Waymo没有谈论HydraNets，但有一些关于其视觉系统的事情。第一件可能会让你感到惊讶的事是，Waymo的架构并不是固定的，而是估计的。

#### **模型**

Waymo使用主动学习来训练模型，利用TPU（Tensor Processing Units）和谷歌的深度学习框架TensorFlow。

### 定位

多年来，谷歌地图团队一直致力于使用激光雷达、摄像头和GPS进行高精地图绘制。这些是用于自动驾驶汽车的精确传感器。Waymo的定位模块由地图、摄像头、GPS和算法组成，可在全世界范围内准确定位车辆。Waymo还在其模块中使用了大量冗余，以使其更加健壮和可靠。

### 预测

相比较于特斯拉利用其客户数十万辆汽车收集数据，然而，他们拥有自己的车队，近年来可能会增长很多。

在自动驾驶汽车中，最终想要的是了解人类行为并预测它们。这就是所谓的行为预测。这些行为预测是使用循环神经网络进行的：它们使用过去的信息来预测未来的行为。因此，可以确切地知道要做什么，并且可以衡量预测的置信度。在其模型中输入**专家偏见**。其预测系统是一个混合体：结合了机器学习和人类知识。人类知识还包括交通法规和不可能的事情

![image-20240123160129020](C:\notreadpaper\assets\image-20240123160129020.png)

### 总结

这可能看起来很复杂，但别担心，这就是我写这篇文章的原因！让我们从顶部开始，将“特征网络”视为感知、定位和预测的输出。

- 在左侧，可以看到“Agent RNN”。这实际上是一个为自主车辆生成轨迹的网络。这些轨迹将考虑航向（可行性）、速度（交通规则）、航路点（长度）和代理（可行性、几何形状等）。Agent RNN的目标是模拟一个可行的、现实的轨迹。
- 然后在右侧，可以看到Road Mask Net。这是一个网络，如果它生成的轨迹不在路上，就会受到很高的惩罚。Waymo通过这种方式确保我们不在人行道上开车。
- 最后，在最右侧，是Perception RNN。这是一个惩罚与其他车辆的碰撞和互动的网络。例如，当我们距离车辆1米的损失会高于距离1.5米时的损失。

总之，网络生成了一条可行的轨迹，保持在路上，避免碰撞。最后，轨迹还考虑了排斥器和吸引器。我们想留在车道的中心，并且想避开路障并跟随中心。

- 感知是检测障碍物、交通灯和道路的。Waymo使用主动学习收集数据，使用AutoML生成架构并选择更高效的架构（准确性和推理时间）。
- 定位主要是找到您所在位置的感知任务。Waymo利用谷歌地图的知识来做到这一点。
- 预测是在模拟器中使用循环神经网络和强化学习来训练他们的代理来很好地估计轨迹。
- 规划是根据可行性生成轨迹，保持在路上，避免碰撞。这些车辆还向人工标注员学习，以生成更逼真的轨迹。

# 激光雷达和摄像头传感器融合

激光雷达代表光检测和测距。它是一个3D传感器，输出一组点云；每个都有一个(X,Y,Z)坐标。可以在3D数据上执行许多应用：包括运行机器学习模型和神经网络。下面是一个输出示例。

![image-20240123164705111](C:\notreadpaper\assets\image-20240123164705111.png)

早期融合是融合来自传感器的原始数据的。因此，一旦插入传感器，该过程就会很快的发生

**点云投影到2D对象监测**

**ROI匹配-融合每个边界框内的数据**

**3D监测+IOU匹配**

- 可以有早期或后期融合--早期融合（低级传感器融合）是关于融合原始数据。后期融合是关于融合对象（中级传感器融合）或轨迹（高级传感器融合）
- 在做早期传感器融合时，要做点云和像素或者框的关联。
- 在进行后期传感器融合时，我们想要做结果（边界框）之间的关联，因此有诸如匈牙利算法和卡尔曼滤波器之类的算法来解决它。

# AUTOSAR-BSW层概述

### what bsw

**BSW层全称为Basic Software （基础软件层），顾名思义，该层主要是为应用层提供基础服务**

这里可以看到 BSW 主要提供了：看门狗服务 ，存储服务，通信和诊断服务，OS服务，I/O 功能，BswM 和 EcuM 等模式管理功能

- 看门狗服务：提供看门狗功能，检测MCU，当MCU挂死的时候可以进行复位重启。

- 存储服务：提供读写数据到 EEPROM的功能。 通信和诊断服务：提供 Can、Lin、Eth 等通信和诊断功能。

- I/O 功能：提供通用GPIO读写功能，ADC、PWM等特殊 Port 外设功能。

- OS 服务：提供基础OS服务，任务周期运行、调度等功能。

- BswM：管理整个Bsw的模块。

- EcuM：管理 Ecu上下电等功能。

## BSW结构介绍

MCAL层（微控制抽象层 MicroController Abstraction Layer）是对MCU 芯片的抽象和封装，由于Autosar Cp 是基于MCU 的软件架构，所以该层主要是实现MCU 外设驱动，比如I/O驱动、Flash 驱动、Can 驱动、看门狗驱动、定时器驱动等等。这一层是需要和硬件打交道的，这一层高度依赖MCU 硬件，如果项目换MCU 芯片，只需要修改这一层代码适配驱动即可。 

ECU 抽象层（ECU Abstraction Layer）是对ECU的抽象和封装，ECU上面除了主芯片MCU，还有很多外围设备，比如外置Flash，外置电源管理芯片等等。这 一层就是实现了整个ECU 所有设备的封装。外围设备也是MCU 主芯片控制的， 这一层会使用到Mcal 的接口。作为抽象层，屏蔽了下层驱动实现细节，将统一 接口API 暴露给上层以实现功能。该层从上层抽象Mcal 层，并提供用于访问外 部和内部的驱动程序的API。 

服务层（Service Layer）是向应用层提供服务的，这一层将底层提供的服务封装起来供应用层使用。比如通信服务、存储服务、os操作系统服务等。 

CDD （Complex Device Drivers）复杂驱动指的是有些模块不适用于Autosar协议栈，通过手写代码自己封装成CDD模块，在项目开发中会经常有一些模块直接作为CDD使用。 

### 通信服务
Mcal 包含了收发器驱动和总线控制器驱动，Mcal 向上提供驱动接口供总线接口层（CanIf LinIf EthIf）调用。
总线接口层（CanIf LinIf EthIf）也就是通信硬件抽象层，主要任务包括向上层模块提供与硬件无关的统一接口，屏蔽下层控制器收发器实现细节。
Bus Tp 层： Tp（Transport Layer）是通信传输层，主要是为诊断使用的，当can Lin 总线需要传输大于 8byte 数据，就需要Tp层进行多帧传输。
PduR 层： Pdu Router 也就是 Pdu 路由层，所有的通信收发都会到这一层进行PDU 路由。 Autosar 中包含了 Can、 Lin、 Eth 等通信，每个通信报文都可以描述成一个 PDU（protocal data unit）协议数据单元，通过 PduR 这一层统一管理每个 Pdu 收发去处。
IPDU Mux： IPDU 多路复用功能，指的是使用同一个 I-PDU 的同一种 PCI，其SDU 有多个不同的布局。
COM：通信报文会到这里。 从 PDUR 接收上来的 I-PDU 到这里会转成具体信号数据给到应用层使用， 应用层通过 RTE 传下来的信号首先到这里转成 I-PDU发到 PduR。应用层无需关注收发数据是通过什么总线传输的，这些收发的数据通过 DBC 文件或者 ARXML 文件事先定义好。 COM 主要起到信号接口和网关作用。 

DCM：诊断报文会到这里，根据诊断要求做具体诊断服务。

# 软件定义汽车（网关 精读）

https://aijishu.com/a/1060000000293341

软件方面：整车功能越来越复杂，软件定义汽车的时代，汽车软件代码量、复杂度和安全性要求都在快速增长。据NXP预测，2015-2025年汽车中代码量有望呈指数级增长，其年均复合增速约为21%。

汽车E/E架构之前一直遵循着“一个功能一个盒子”的分布式架构模式，在这样的汽车电子电气架构形式下，每增加一个功能，就需要增加相应的控制器，进一步增加系统的复杂性，而目前OEM为了整合软件、简化整车线束及降低成本逐渐开始走域控Domain Control、区域控制Zone Control的道路。

![image-20240126135837466](C:\notreadpaper\assets\image-20240126135837466.png)

### NXP域控芯片——S32系列

NXP在2017年发布了S32系列产品组合，针对汽车上不同的应用场景，覆盖了车身，雷达，网关，底盘动力等不同应用，向主机厂和Tier1提供丰富的产品支持。

![image-20240126140013047](C:\notreadpaper\assets\image-20240126140013047.png)

S32系列各个产品共用多个IP核，使得在不同ECU之间例如域控制器(Domain)，区域控制器(Zonal)，以及终端节点(Node)可以共用软件，包括基础BSP和信息安全及功能安全的相关开发设计成果。S32G主要应对如下目标应用：

- **中央网关：**需要对确定性网络通信和其它处理任务负载进行加速，并需要为新兴无线服务提供嵌入式安全
- **服务型网关：**需要高性能应用处理，并提供隔离功能，以快速部署新的安全服务
- **域控制器：**需要高性能实时和应用处理，以支持 ECU 整合、 网络协议转换和本地域控制
- **安全协处理器：**需要 ASIL D 功能安全处理以及网络连接和 PCI Express®，以便与其他组件和中央大容量存储器共享数据
- **中央车控单元：**新电子电气架构趋势下，服务型网关上融合了越来越多的功能(例如VCU, BCM等)

通常基于S32G的服务型网关或中央车控单元的基本系统框图如下，外围电路需要搭配专用PMIC芯片VR5510，CAN和以太网收发芯片，以及必要的存储芯片等。

![image-20240126140146402](C:\notreadpaper\assets\image-20240126140146402.png)

### **通讯加速模块助力SOA的网关应用**

伴随着汽车智能化、网联化、共享化的趋势，终端用户对车辆功能的预期也悄然发生着改变，汽车在实现高等级自动驾驶/辅助驾驶功能的同时，也更趋向于提升用户体验，例如满足快速的功能更新和升级，可以提供个性化、人性化、差异化的功能与服务等。面向服务的软件架构(Service-Oriented Architecture)正为未来的车辆软件服务提供良好的解决方案。

![image-20240126140419897](C:\notreadpaper\assets\image-20240126140419897.png)

基于信号的通讯仅支持发送和接收模式，支持的数据类型简单且可扩展性差，适用于有限大小数据交互的应用场景。而诸如自动驾驶等先进应用场景加入后，大量数据的动态交互必须采用面向服务的通讯方式以提高通讯效率降低负载，在该种方式下，接收者作为客户端，只需要查找、订阅服务等待接收信息即可，而发送者作为服务提供者只需要给订阅者提供服务和信息即可，因基于SOA的通讯支持请求/响应模式，可扩展性强且支持复杂数据的传输。SOA的应用要基于以太网，而在通讯方面，S32G有丰富的通讯接口，有20个CAN接口，4个千兆以太网接口和2个PCIe 3.0接口，为不管是网关还是域控等各种应用场景的支持提供了灵活性。

### 总结

因此S32G用加速器来完成CAN和以太网路由通信，大大释放了M核和A核的算力，通过加速器之间配合，即可完成CAN-to-CAN, CAN-to-Eth, Eth-to-CAN, Eth-to-Eth的路由转发功能。随着通信带宽和路数增加，加速器可以承担更多处理任务，而不影响A核和M核上的应用软件的执行。使用加速器之后，网关所需算力，按照实际车厂项目经验，约为0.5个M7核，即650 DMIPS。

在传统网关应用以及新一代中央车控应用中，CAN和以太网的快速启动/快速唤醒是一个必备的功能。各个OEM车厂要求未必一致，但是常规会要求CAN唤醒在100ms之内，即短时间内唤醒处理器执行软件，并将收到的CAN报文路由送到另外的ECU。现今以太网唤醒也类似要求，区域控制器(ZCU或者VIU)未来通过实时以太网跟中央车控CCU相连，需要短时间内将以太网数据送给CCU并执行相应的动作。通常，实现休眠后快速唤醒的几个必要条件如下：

- a. 需要是快速中断响应的MCU核
- b.需要运行实时代码或实时操作系统，例如AUTOSAR CP
- c.需要唤醒后有立即可执行代码的物理空间，例如SRAM或者Flash。

过去常规MCU可以执行代码在片上Flash Memory，因此能较好的满足休眠唤醒的时间要求。而部分SOC因为唤醒后，需要在DDR Memory上执行代码，而通常DDR因为是需要训练参数，因此往往有较长的建立时间而不满足休眠唤醒要求。(如果DDR休眠不掉电而处于自刷新状态，则会存在颗粒寿命大大缩短的问题)。

S32G2自带的8MB SRAM可以将AUTOSAR CP的全部软件运行在SRAM中(S32G3提供20MB SRAM)，可以将硬件初始化时间控制在32毫秒左右即可跳转到用户的bootloader代码，最终实现快速唤醒的功能。

# ECU故障诊断

https://aijishu.com/a/1060000000293747

本文将从系统，设计和实现3个角度来介绍汽车控制器（ECU）故障诊断系统：

- 在系统角度，了解为什么需要故障诊断系统，利用它可以做什么，以及它是什么；
- 在设计角度，了解故障怎么管理，怎么识别，怎么处理；
- 在实现角度，了解基于AUTOSAR架构的故障诊断系统实现机制。

## 介绍

汽车的各个控制器都需要故障诊断系统，去不断检测系统、零件等的异常之处，从中找出故障，找出故障后，还希望一方面可以采取临时补救措施，将伤害减到最小，另一方面，保存故障信息，以供后续排查和解决故障。因此，基于这样的需求，完整的ECU故障诊断系统包括车内在线诊断系统和车外离线诊断系统两个部分，将两者配合使用，就可以进行完整地故障诊断。

车外离线诊断系统用于提取已保存的故障信息，通过向车内在线诊断系统发送服务请求（即使用UDS服务）的形式，可进行读取故障码信息、清除故障码和刷写软件等操作，完成故障的调查与维修。

![image-20240227151014457](C:\notreadpaper\assets\image-20240227151014457.png)

ECU故障诊断系统检测的故障主要有五种类型：

- 机械/系统故障，以变速箱控制器所涉及的故障为例，像挡位执行器坏了，离合器坏了等故障；
- 电子电器故障，比如电磁阀或传感器短路，电源电压不在工作范围等故障；
- 硬件故障，主要指PCB上的器件故障，比如处理器故障，外围芯片故障等；
- 软件故障，比如死循环， 除零，溢出等故障；
- 通讯故障， 比如CAN连不上，CAN报文丢失等故障。

## 故障确认

总的来说，Debouncing算法原理是：根据检测到“故障”状态（PREFAILED, FAILED, PREPASSED, PASSED）来增减计数器或定时器，只有次数或时间达到阈值，才能确认或消除故障。

当故障被确认，那么车内在线诊断系统一方面将故障码DTC及相关数据存入ECU内部的非易失存储器内；另一方面将对故障进行处理，主要包括点灯策略和故障处理策略。其中，点灯策略是指根据故障的严重程度决定是否点亮故障指示灯以及点亮何种颜色，以此警示驾驶员故障的存在，而故障处理策略是指根据故障的严重程度决定做怎样的临时处理措施。

## 车外诊断

需要使用到统一诊断服务（Unified Diagnostic Services，UDS），当然涉及排放会使用到OBD服务，这里仅介绍UDS服务。UDS服务是诊断服务的规范化标准，规定了读取DTC的指令，读诊断数据流的指令等。

总的来说，按功能划分，UDS服务可分为6类，共26种服务，分别是：

- 1）诊断和通信管理功能单元，包括10，11，27，28，3E，83，84，85，86，87共10种服务；
- 2）数据传输功能单元，包括22，23，24，2A，2C，2E，3D共7种服务；
- 3）存储数据传输功能单元，包括14，19共2种服务；
- 4）输入输出控制功能单元，包括2F服务；
- 5）例行程序功能单元，包括31服务；
- 6）上传下载控制功能单元，包括34，35，36，37，38共5种服务

## AUTOSAR ECU诊断

对于AUTOSAR软件架构，故障诊断既会在底层软件BSW实施，也会在应用层软件ASW实施，具体看如何定义两者的边界。

诊断事件管理模块Dem负责对故障诊断、处理、保存和管理。比如Dem通过NvM提供的接口访问非易失存储器，读取和保存故障信息。同时Dem向Dcm提供访问故障数据的接口，如读故障码，清楚故障码等操作。

NvM是指非易失性存储管理模块，管理非易失性数据的存储和维护。当Dem确认到故障，Dem调用NvM的写函数，把故障信息和发生故障时的环境数据写入到NvM。当Dem要查询故障信息，Dem调用NvM的读函数，从NvM中，读取故障信息和发生故障时的环境数据。

FiM模块是为SW-C提供一个控制机制，即使能或抑制SW-C功能。比如当故障确认后，可以通过FiM抑制一些与此故障相关的SW-C功能，像抑制了检测速度的SW-C功能，那就意味着基于速度来检测故障的前提条件就无法满意，相应地此类故障都将无法诊断。

**当有可能但还不足以确认时，那么可以采用debouncing算法，通过基于计数或计时的方法来确认。**

当故障车辆到维修车间，维修人员将使用测试仪器，查询故障信息。比如，使用19服务获取电磁阀短路得到这个DTC相关信息，这时Dcm模块的19服务映射的函数将调用Dem提供的接口函数，通过这些函数获取DTC相关信息。类似的逻辑，可以通过14服务清楚故障。

![image-20240227151659507](C:\notreadpaper\assets\image-20240227151659507.png)

# [汽车域控制器集成化架构的背景、优点及设计](https://aijishu.com/a/1060000000300172)

随着车辆的电子化程度逐渐提高，电子控制单元（ECU）占领了整个汽车。从防抱死制动系统、四轮驱动系统、电控自动变速器、主动悬架系统、安全气囊系统，逐渐延伸到了车身安全、网络、娱乐、传感控制系统等。随着汽车电子功能的丰富性和复杂性不断提高，汽车ECU数量都在逐年递增，一些高端车型的ECU数量已经破百。

用一个或几个“大脑”来操控全车的ECU与传感器正逐渐成为汽车电子电气架构公认的未来，以域为单位的域控制器（Domain Controller Unit）集成化架构是当前最佳的解决方案。按照最典型的分类方法可分为**动力总成、底盘控制、车身控制、娱乐系统（座舱域）、ADAS**这五个主要的域。各个域内部的系统互联仍可使用现如今十分常用的CAN和FlexRay通信总线。而不同域之间的通讯，则需要由更高传输性能的以太网作为主干网络承担信息交换任务。

未来的汽车电子架构正在迅速革新。安全特性以及对自动驾驶功能需要有更好的计算能力以及更高带宽的通讯能力。为了使汽车具有更好的连接能力以及信息娱乐功能，汽车将会被改造一个分布式IT系统，能够与云端进行通信以远程更新软件，同时实时更新数字地图信息与交通路况。

在未来的汽车电子电气架构中，中央网关将作为信息桥梁，交换信息并隔离车内域控制器和外围通信源，如移动网络、蓝牙、WiFi、以太网等，它还将同时充当汽车的中央诊断接口用于系统漏洞的诊断。域控制器可被用作中央网关与本地智能传感器、执行器和ECU之间的网关，在以太网和CAN或LIN之间编译和传递信息。

中央网关将承担维护网络安全的主要责任。中央网关检验来自合法源的消息，并保护身份验证不受欺骗，将网络通信限制到预定义的正常范围内，限制异常或过多消息的通信，以避免损害车辆的功能。它还需要阻止未经批准的非法消息，并对无效尝试给出警告。这可以大大提高整车的网络安全性，并显着降低车载域控制器的安全功能负载。

消费者对汽车安全特性和软件功能的需求正以前所未有的速度增长。这种趋势使得汽车的电子电气架构正在从分布式电子控制器单元 (ECU)  转向集成度更高的域控制器。汽车对计算能力和存储能力的要求也越来越高。以域控制器为代表的电子电气框架可以提供更快速，更安全，更可靠的数据处理和能源分配能力。带有域控制器的未来汽车平台可以轻松利用云计算、互联网、大数据以及OTA升级等最新技术。强大的多核处理能力、专用的车载嵌入式操作系统、创新的电子电气架构以及高带宽的通信能力是未来域控制器架构汽车的基本组成要素。

# AUTOSAR

集中化E/E架构需要在软件架构层面的适当支持。汽车行业一直在逐步遵守包括AUTOSAR在内的几个标准。AUTOSAR标准化的趋势有几个优势，所有这些优势都与E/E集中化的目标相一致，如促进来自不同供应商的部件集成，不同的车辆项目和平台的组件重用，以及以系统的方式控制故障。在这一节中，我们重点讨论AUTOSAR为集中式架构提供的支持。

AUTOSAR（汽车开放系统架构）提供了一个用于开发汽车嵌入式系统的框架。

关于功能安全，AUTOSAR定义了便于检测和处理故障的机制，以确保在符合AUTOSAR的ECU中为SWC提供无干扰的执行环境，这是符合ISO 26262的必要条件。AUTOSAR通过诊断机制（如核心和RAM测试）支持硬件的功能安全。为了支持安保性，AUTOSAR定义了安全车载通信（SecOC）模块，这是一个BSW模块，为汽车网络内的敏感数据传输提供认证机制。此外，AUTOSAR定义了加密抽象库（CAL）和加密服务管理器（CSM），以支持加密服务。行业向集中式E/E架构的转变，往往需要将已经验证的AUTOSAR顺序应用迁移到现代多核平台上。。。。。。。。。。。。。。。。。。

# 整车上下电流程

大多数是采用网络唤醒，因为整车上有八九十个ECU，采用硬线控制会使总成本和重量都增加，而且通过网络控制更加灵活。

当钥匙按下解锁键或打开车门或按下启动键时，唤醒信号通过网关转发至整车控制器(VCU)，并将其唤醒，VCU唤醒后控制低压继电器盒，使其他ECU上电，并通过发送网络管理将其ECU唤醒，ECU启动并完成自检后，如果没有问题，则可以正常工作了，然后在上高压电(后面会讲)。

# [基于“驾驶环境全息模型”的高阶单车智能驾驶技术路线探索](https://aijishu.com/a/1060000000301264)

智能驾驶控制系统是一个复杂的大系统，基于  “驾驶环境全息模型”的智能驾驶技术路线，依靠V2X等设备传输精准的驾驶环境数据来构建精准的“驾驶环境全息模型”，为智能驾驶控制系统提供精准的决策依据，解决了传统驾驶环境感知层由于受传感器技术、环境干扰、感知精度、识别算法、数据融合技术等因素的限制带来的驾驶环境数据的不确定性和不准确性导致的智能驾驶的决策的不可靠和不可信的问题，促进了高阶智能驾驶系统技术发展、进步、实现和落地。